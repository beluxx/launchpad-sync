Caching country mirrors
=======================

The https://launchpad.net/ubuntu/+countrymirrors-archive page serves the
list of official Ubuntu mirrors for the country where the request was
originated.  This functionality is provided so that apt can pick the
mirror which is geographically closer to the box where it's running.
One problem with that, though, is that there are way too many Ubuntu
users and most of them will update their systems when security updates
are available, causing apt to DDoS Launchpad.  To avoid that we'll
periodically generate static versions of these lists and serve them
through apache.

These static versions are generated by the cache-country-mirrors.py
script, which takes a single argument -- the directory in which the
files are saved.

    >>> from subprocess import Popen, PIPE
    >>> import tempfile
    >>> directory = tempfile.mkdtemp()
    >>> process = Popen(
    ...     "scripts/cache-country-mirrors.py -q %s" % directory,
    ...     shell=True,
    ...     stdin=PIPE,
    ...     stdout=PIPE,
    ...     stderr=PIPE,
    ...     universal_newlines=True,
    ... )
    >>> (out, err) = process.communicate()
    >>> print(out)
    <BLANKLINE>
    >>> print(err)
    <BLANKLINE>
    >>> process.returncode
    0

Let's have a look at the files generated by our script to see if they
look good.

    >>> import os
    >>> import stat

    >>> files = os.listdir(directory)
    >>> len(files)
    240
    >>> set(["BR.txt", "AR.txt", "CO.txt", "CL.txt"]).issubset(files)
    True
    >>> fr_txt_path = os.path.join(directory, "FR.txt")
    >>> print("%o" % stat.S_IMODE(os.stat(fr_txt_path).st_mode))
    644
    >>> with open(fr_txt_path) as fr_txt:
    ...     for line in sorted(fr_txt.read().split("\n")):
    ...         print(line)
    ...
    http://archive.ubuntu.com/ubuntu/
    http://localhost:11375/archive-mirror/
    http://localhost:11375/valid-mirror/

Cleanup!

    >>> import shutil
    >>> shutil.rmtree(directory)

