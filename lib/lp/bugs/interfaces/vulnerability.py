# Copyright 2022 Canonical Ltd.  This software is licensed under the
# GNU Affero General Public License version 3 (see the file LICENSE).

"""Vulnerability interfaces."""

__all__ = [
    'IVulnerability',
    'IVulnerabilityActivity',
    'IVulnerabilityActivitySet',
    'IVulnerabilitySet',
    'VulnerabilityChange',
    ]

from lazr.enum import (
    DBEnumeratedType,
    DBItem,
    )
from lazr.restful.declarations import (
    exported,
    exported_as_webservice_entry,
    )
from lazr.restful.fields import Reference
from zope.interface import Interface
from zope.schema import (
    Choice,
    Datetime,
    Int,
    TextLine,
    )

from lp import _
from lp.app.enums import InformationType
from lp.app.interfaces.informationtype import IInformationType
from lp.bugs.enums import VulnerabilityStatus
from lp.bugs.interfaces.bugtask import BugTaskImportance
from lp.bugs.interfaces.cve import ICve
from lp.registry.interfaces.distribution import IDistribution
from lp.registry.interfaces.person import IPerson


class VulnerabilityChange(DBEnumeratedType):
    """Type of change in vulnerability

    We use this enum to track changes occurring in
    data stored in the vulnerability table.
    """

    STATUS = DBItem(0, """
        Status

        The status of the vulnerability changed.
        """)

    DESCRIPTION = DBItem(1, """
        Description

        The description of the vulnerability changed.
        """)

    NOTES = DBItem(2, """
        Notes

        The notes on the vulnerability changed.
        """)

    MITIGATION = DBItem(3, """
        Mitigation

        Mitigation for this vulnerability changed.
        """)

    IMPORTANCE = DBItem(4, """
        Importance

        The importance assigned for this vulnerability changed.
        """)

    IMPORTANCE_EXPLANATION = DBItem(5, """
        Importance explanation

        The importance explanation changed for this vulnerability.
        """)

    PRIVACY = DBItem(6, """
        Privacy

        The privacy for this vulnerability changed.
        """)


class IVulnerabilityView(Interface):
    """`IVulnerability` attributes that require launchpad.View."""

    id = exported(
        Int(title=_("ID"), required=True, readonly=True),
        as_of="devel"
    )

    distribution = exported(
        Reference(
            IDistribution,
            title=_("Distribution"),
            required=True,
            readonly=True
        ),
        as_of="devel"
    )

    cve = exported(
        Reference(
            ICve,
            title=_('External CVE reference corresponding'
                    ' to this vulnerability, if any.'),
            required=False,
            readonly=True
        ),
        as_of="devel"
    )

    date_created = exported(
        Datetime(
            title=_("The date this vulnerability was created."),
            required=True,
            readonly=True
        ),
        as_of="devel"
    )

    creator = exported(
        Reference(
            title=_('The person who created the vulnerability.'),
            schema=IPerson,
            required=True,
            readonly=True
        ),
        as_of="devel"
    )


class IVulnerabilityEditableAttributes(Interface):
    """`IVulnerability` attributes that can be edited.

    These attributes need launchpad.View to see, and launchpad.Edit to change.
    """

    status = exported(
        Choice(
            title=_('The status of the vulnerability.'),
            readonly=False,
            required=True,
            vocabulary=VulnerabilityStatus
        ),
        as_of="devel"
    )

    description = exported(
        TextLine(
            title=_("A short description of the vulnerability."),
            required=False,
            readonly=False
        ),
        as_of="devel"
    )

    notes = exported(
        TextLine(
            title=_("Free-form notes for this vulnerability."),
            required=False,
            readonly=False
        ),
        as_of="devel"
    )

    mitigation = exported(
        TextLine(
            title=_("Explains why we're ignoring this vulnerability."),
            required=False,
            readonly=False
        ),
        as_of="devel"
    )

    importance = exported(
        Choice(
            title=_('Indicates the work priority, not the severity'),
            vocabulary=BugTaskImportance,
            required=True,
            default=BugTaskImportance.UNDECIDED,
            readonly=False,
        ),
        as_of="devel"
    )

    importance_explanation = exported(
        TextLine(
            title=_("Used to explain why our importance differs "
                    "from somebody else's CVSS score."),
            required=False,
            readonly=False
        ),
        as_of="devel"
    )

    information_type = exported(
        Choice(
            title=_("Information type"),
            vocabulary=InformationType,
            required=True,
            readonly=False,
            default=InformationType.PUBLIC,
            description=_(
                "Indicates the privacy of the vulnerability."
            )
        ),
        as_of="devel"
    )

    date_made_public = exported(
        Datetime(
            title=_("The date this vulnerability was made public."),
            required=False,
            readonly=False
        ),
        as_of="devel"
    )


class IVulnerabilityEdit(Interface):
    """`IVulnerability` attributes that require launchpad.Edit."""


# XXX lgp171188 2022-04-20 bug=760849: "beta" is a lie to get WADL
# generation working.  Individual attributes must set their version to
# "devel".
@exported_as_webservice_entry(as_of="beta")
class IVulnerability(IVulnerabilityView,
                     IVulnerabilityEditableAttributes,
                     IVulnerabilityEdit, IInformationType):
    """A vulnerability."""


class IVulnerabilitySet(Interface):
    """The set of all vulnerabilities."""

    def new(distribution, status, importance,
            creator, information_type=InformationType.PUBLIC, cve=None,
            description=None, notes=None, mitigation=None,
            importance_explanation=None, date_made_public=None):
        """Return a new vulnerability.

        :param distribution: The distribution for the vulnerability.
        :param status: The status of the vulnerability.
        :param importance: Indicates work priority, not severity.
        :param creator: The user that created the vulnerability.
        :param information_type: The privacy of the vulnerability.
        :param cve: A `Cve` for which the vulnerability is being created.
        :param description: The description of the vulnerability.
        :param notes: The notes for the vulnerability.
        :param mitigation: A short summary of the result.
        :param importance_explanation: Used to explain why our importance
         differs from somebody else's CVSS score.
        :param date_made_public: The date this vulnerability was made public.
        """


class IVulnerabilityActivity(Interface):
    """`IVulnerabilityActivity` attributes that require launchpad.View."""

    id = Int(title=_("ID"), required=True, readonly=True)

    vulnerability = Reference(IVulnerability, title=_('Vulnerability'),
                              required=True, readonly=True)

    date_changed = Datetime(
        title=_("When activity last changed for this vulnerability."),
        required=True, readonly=True)

    changer = Reference(IPerson, title=_("Changer"), required=True,
                        readonly=True,
                        description=_("The person that made the changes."))

    what_changed = Choice(
        title=_('Indicates what field changed for the vulnerability.'),
        readonly=True,
        required=True, vocabulary=VulnerabilityChange)

    old_value = TextLine(
        title=_("Indicates the value prior to the change."), required=False,
        readonly=True)

    new_value = TextLine(
        title=_("Indicates the current value."), required=False,
        readonly=True)


class IVulnerabilityActivitySet(Interface):
    """The set of all activities for a certain vulnerability."""

    def new(vulnerability, changer, what_changed=None,
            old_value=None, new_value=None):
        """Return a new vulnerability activity.

        :param vulnerability: The vulnerability for this activity.
        :param changer: The `Person` that performed the activity.
        :param what_changed: The 'VulnerabilityChange' that occurred
         for this vulnerability.
        :param old_value: Indicates the value prior to the change.
        :param new_value: Indicates the current value.
        """
