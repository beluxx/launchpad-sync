# Copyright 2022 Canonical Ltd.  This software is licensed under the
# GNU Affero General Public License version 3 (see the file LICENSE).

__all__ = [
    'Vulnerability',
    'VulnerabilitySet',
    ]

from lp.bugs.interfaces.bugtask import BugTaskImportance
from lp.bugs.interfaces.vulnerability import VulnerabilityStatus, IVulnerability
from lp.services.database.enumcol import DBEnum
from lp.services.database.interfaces import IStore
from lp.services.database.stormbase import StormBase
from storm.locals import (
    Bool,
    DateTime,
    Int,
    Reference,
    Unicode,
    )
from zope.interface import implementer


@implementer(IVulnerability)
class Vulnerability(StormBase):
    __storm_table__ = 'Vulnerability'

    id = Int(primary=True)

    distribution_id = Int(name="distribution", allow_none=True, default=None)
    distribution = Reference(distribution_id, "Distribution.id")

    cve_id = Int(name="cve", allow_none=True, default=None)
    cve = Reference(cve_id, "Cve.id")

    status = DBEnum(name='status', allow_none=True,
                    enum=VulnerabilityStatus)

    description = Unicode(name='description', allow_none=True)

    notes = Unicode(name='notes', allow_none=True)

    mitigation = Unicode(name='mitigation', allow_none=True)

    importance = DBEnum(
        name='importance', allow_none=False,
        enum=BugTaskImportance,
        default=BugTaskImportance.UNDECIDED)

    importance_explanation = Unicode(
        name='importance_explanation', allow_none=True)

    private = Bool(name='private', allow_none=False, default=False)

    def __init__(self, distribution, cve, status, description,
                 notes, mitigation, importance, importance_explanation,
                 private):
        super().__init__()
        self.distribution = distribution
        self.cve = cve
        self.status = status
        self.description = description
        self.notes = notes
        self.mitigation = mitigation
        self.importance = importance
        self.importance_explanation = importance_explanation
        self.private = private


@implementer(IVulnerability)
class VulnerabilitySet:

    def new(self, distribution, cve, status, description,
            notes, mitigation, importance, importance_explanation,
            private):
        """See `VulnerabilitySet`."""
        store = IStore(Vulnerability)
        vulnerability = Vulnerability(distribution, cve, status, description,
                                      notes, mitigation, importance,
                                      importance_explanation, private)
        store.add(vulnerability)
        return vulnerability

    def getByID(self, id):
        return IStore(
            Vulnerability).find(Vulnerability, id=id).one()
