# Copyright 2022 Canonical Ltd.  This software is licensed under the
# GNU Affero General Public License version 3 (see the file LICENSE).

"""Vulnerability subscription model."""

__all__ = ["VulnerabilitySubscription"]

from datetime import timezone

from storm.properties import DateTime, Int
from storm.references import Reference
from zope.interface import implementer

from lp.bugs.interfaces.vulnerabilitysubscription import (
    IVulnerabilitySubscription,
)
from lp.registry.interfaces.person import validate_person
from lp.registry.interfaces.role import IPersonRoles
from lp.registry.model.person import Person
from lp.services.database.constants import UTC_NOW
from lp.services.database.stormbase import StormBase


@implementer(IVulnerabilitySubscription)
class VulnerabilitySubscription(StormBase):
    """A relationship between a person and a vulnerability."""

    __storm_table__ = "VulnerabilitySubscription"

    id = Int(primary=True)

    person_id = Int("person", allow_none=False, validator=validate_person)
    person = Reference(person_id, "Person.id")

    vulnerability_id = Int("vulnerability", allow_none=False)
    vulnerability = Reference(vulnerability_id, "Vulnerability.id")

    date_created = DateTime(
        allow_none=False, default=UTC_NOW, tzinfo=timezone.utc
    )

    subscribed_by_id = Int(
        "subscribed_by", allow_none=False, validator=validate_person
    )
    subscribed_by = Reference(subscribed_by_id, "Person.id")

    def __init__(self, vulnerability, person, subscribed_by):
        super().__init__()
        self.vulnerability = vulnerability
        self.person = person
        self.subscribed_by = subscribed_by

    def canBeUnsubscribedByUser(self, user: Person) -> bool:
        """See `IVulnerabilitySubscription`."""
        if user is None:
            return False
        return (
            user.inTeam(self.vulnerability.creator)
            or user.inTeam(self.vulnerability.distribution.owner)
            or user.inTeam(self.vulnerability.distribution.security_admin)
            or user.inTeam(self.person)
            or user.inTeam(self.subscribed_by)
            or IPersonRoles(user).in_admin
        )
